<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/config/defaultLayout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/css/item/orders.css">
    <script>
        window.onload = function () {
            setPrice();
        }

        $(document).on("change", "#useCoupon", function(){
            let orderId = $("#orderId").val();
            let useCoupon = $("#useCoupon").val();

            if(useCoupon !== 0){
                $.ajax({
                    method : "PATCH",
                    url : "/orders/" + orderId,
                    data : {
                        benefit : String(useCoupon)
                    },
                    success : (res) => {

                    }
                })
            }

            setPrice();
        })
        function setPrice(){
            let orderPrice = parseInt(document.getElementById("orderPrice").innerText);
            let deliveryPrice = orderPrice >= 5000 ? 0 : 3000;
            let discountRate = parseFloat(document.getElementById("useCoupon").value) / 100;
            let discountPrice = parseInt(orderPrice * discountRate);

            document.getElementById("totalPrice").innerText = String(parseInt((orderPrice - discountPrice) + deliveryPrice));
            document.getElementById("deliveryPrice").innerText = String(deliveryPrice);
            document.querySelectorAll(".discountPrice")
                .forEach(
                    (d) => {
                        d.innerText = String(discountPrice)
                    }
                )
        }
        function delOrder(orderId){
            $.ajax({
                method : "DELETE",
                url : "/orders/" + orderId,
                success : function () {
                    location.href = "/my/cart";
                }
            })
        }
        function updateOrderStatus(orderId, status){

            let newAddressYN = document.getElementById("newRecipient");

            if(newAddressYN != null){
                $.ajax({
                    method : "PATCH",
                    url : "/orders/" + orderId + "/address",
                    data : {
                        recipient : $("#newRecipient").val(),
                        recipientNumber : $("#newPhoneNumber").val(),
                        defaultYN : true,
                        address : $("#newAddr").val(),
                        success : () => {}
                    }
                })
            }

            let data = {
                orderId : orderId,
                status : status
            }

            $.ajax({
                method : "PUT",
                url : "/orders/success",
                contentType : "application/json",
                data : JSON.stringify(data),
                success : function (res) {
                    location.href = "/orders/" + orderId + "/success";
                },
                error : function (err, xhr, status) {
                    console.log(`error = ${err}, xhr = ${status}`);
                }
            })
        }
    </script>
</head>
<body>
<div class="container" layout:fragment="content">
    <div class="tt_step">
        <input type="hidden" th:value="${orderId}" id="orderId">
        <p><span class="order_flow" id="cart">장바구니</span><span class="order_flow" id="order">주문/결제</span><span class="order_flow" id="complete">주문완료</span></p>
    </div>
    <div class="title">
        <h2>주문/결제</h2>
    </div>
    <div class="tbl_count">
        <h3>주문내역 확인 및 할인적용</h3>
    </div>

    <div class="tbl_prodInfo">
        <table class="tbl_basket">
            <colgroup>
                <col style="width:640px">
                <col style="width:180px">
                <col style="width:160px">
            </colgroup>
            <thead>
                <th scope="col" id="productInfo">상품/옵션 정보</th>
                <th scope="col" id="quantity">수량</th>
                <th scope="col" id="price">주문 금액</th>
            </thead>
            <tbody>
                <tr th:each="cart : ${cartList}">
                    <td>
                        <div class="prodWrap">
                            <div class="prodImg"><img src="#" alt="#" th:src="${cart.getThumbnailURL()}"></div>
                            <div class="prodInfo">
                                <p th:text="${cart.getTitle()}">title</p>
                                <p><span th:text="${cart.getColor()}">color</span>, <span th:text="${cart.getSize()}">size</span></p>
                            </div>
                        </div>
                    </td>
                    <td style="text-align: center"><p th:text="${cart.getCount()}">0</p></td>
                    <td style="text-align: center"><p th:text="${cart.getPrice()}">150000원</p></td>
                </tr>
            </tbody>
        </table>

        <div class="coupon">
            <div class="couponInfo">
                <div>
                    <p style="border-bottom: solid #dbdbdb 0.5px; padding-bottom: 20px">
                        <span>주문금액</span> <span id="orderPrice" th:text="${totalPrice}" style="float: right"></span>
                    </p>
                </div>
                <p><span>할인금액</span> <span class="discountPrice" th:text="${discountAmount}" style="float: right">0</span></p>
                <p style="padding-bottom: 20px;border-bottom: #dbdbdb 0.5px solid">
                    <span>쿠폰</span>
                    <select name="useCoupon" id="useCoupon" style="margin-left: 100px">
                        <option value="0" selected>선택</option>
                        <option th:each="coupon : ${couponList}" th:value="${coupon.getBenefit()}" th:text="${coupon.getTitle()}">선택</option>
                    </select>
                    <span class="discountPrice" th:text="${discountAmount}" style="float: right">0</span>
                </p>
                <p>
                    <span>배송료</span>
                    <span id="deliveryPrice" style="float:right" th:text="${totalPrice >= 30000 ? 0 : 3000}">0원</span>
                </p>
            </div>
            <div class="priceInfo">
                <p style="font-weight: bold">결제 예정 금액</p>
                <p style="color: gray">주문금액 + 할인 금액 + 배송료</p>
                <br><br>
                <p style="font-weight: bold; font-size: 20px; color: red;"><span id="totalPrice" th:text="${paymentAmount}"></span>원</p>
            </div>
        </div>
    </div>
    <br><br>
    <div class="deliveryAddress">
        <div class="addressTitle">
            <h3>주문자 및 배송지 정보</h3>
        </div>
        <div class="addressInfo" th:if="${deliveryAddr == null}">
            <div class="row">
                <div class="label">
                    <label for="newRecipient">받으실 분</label>
                    <span>*</span>
                </div>
                <div class="input">
                    <input type="text" id="newRecipient" name="recipient">
                </div>
            </div>
            <div class="row">
                <div class="label">
                    <label for="newCustEmailId">이메일</label>
                    <span>*</span>
                </div>
                <div class="input">
                    <input type="text" id="newCustEmailId" name="custEmailId" th:value="${member.getEmail().split('@')[0]}">
                    @
                    <input type="text" id="newCustEmailDomain" name="custEmailDomain" th:value="${member.getEmail().split('@')[1]}">
                </div>
            </div>
            <div class="row">
                <div class="label">
                    <label for="newPhoneNumber">휴대폰번호</label>
                    <span>*</span>
                </div>
                <div class="input">
                    <input type="text" id="newPhoneNumber" name="phoneNumber" th:value="${member.getPhoneNumber()}">
                </div>
            </div>
            <div class="row">
                <div class="label">
                    <label for="newAddr">배송지 주소</label>
                </div>
                <div class="input">
                    <input type="text" id="newAddr" name="address">
                </div>
            </div>
        </div>


        <div class="addressInfo" th:if="${deliveryAddr != null}">
            <div class="row">
                <div class="label">
                    <label for="recipient">받으실 분</label>
                    <span>*</span>
                </div>
                <div class="input">
                    <input type="text" id="recipient" name="recipient" th:value="${deliveryAddr.getRecipient()}" disabled>
                    <button type="button" id="addrSelectBtn" onclick="location.href='/my/delivery-addr'">배송지 선택</button>
                </div>
            </div>
            <div class="row">
                <div class="label">
                    <label for="custEmailId">이메일</label>
                    <span>*</span>
                </div>
                <div class="input">
                    <input type="text" id="custEmailId" name="custEmailId" th:value="${member.getEmail().split('@')[0]}" disabled>
                    @
                    <input type="text" id="custEmailDomain" name="custEmailDomain" th:value="${member.getEmail().split('@')[1]}" disabled>
                    <select name="emailDomain" id="emailDomain" disabled>
                        <option value="" th:each="email : ${emailList}" th:value="${email}" th:text="${email}"
                                th:selected="${member.getEmail().split('@')[1].equals(email)}">
                        </option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="label">
                    <label for="phoneNumber">휴대폰번호</label>
                    <span>*</span>
                </div>
                <div class="input">
                    <input type="text" id="phoneNumber" name="phoneNumber" th:value="${member.getPhoneNumber()}" disabled>
                </div>
            </div>
            <div class="row">
                <div class="label">
                    <label for="addr">배송지 주소</label>
                </div>
                <div class="input">
                    <input type="text" id="addr" name="addr" th:value="${deliveryAddr.getAddress() + deliveryAddr.getDetailAddress()}" disabled>
                </div>
            </div>
        </div>
    </div>
    <div class="button">
        <button type="button" id="submitBtn" th:onclick="|updateOrderStatus(${orderId}, 'PAYMENT')|">결제하기</button>
        <button type="button" id="resetBtn" th:onclick="|delOrder(${orderId})|">취소하기</button>
    </div>

    <div id="popup" class="hidden">
        <div class="modalWrap">
            <div class="modalTitle" style="border-bottom: solid 1px; margin-bottom: 10px;">
                <h3>배송지 변경</h3>
            </div>
            <div class="modalContent">
                <div class="addr-row" th:each="addr : ${deliveryAddr}">
                    <p><span th:text="${addr.getRecipient()}">받으실분</span>
                        <button type="button" style="float: right;"
                                th:data-param1="${addr.getRecipient()}" th:data-param2="${addr.getRecipientNumber()}"
                                th:data-param3="${addr.getZipCode()}" th:data-param4="${addr.getAddress()}"
                                th:data-param5="${addr.getDetailAddress()}"
                                th:onclick="|changeAddress(this.getAttribute('data-param1'), this.getAttribute('data-param2'),
                                this.getAttribute('data-param3'), this.getAttribute('data-param4'), this.getAttribute('data-param5'))|">선택</button>
                    </p>
                    <p><span th:text="${addr.getRecipientNumber()}">전화번호</span></p>
                    <p><span th:text="${addr.getZipCode()}"></span></p>
                    <p><span th:text="${addr.getAddress()}">주소</span></p>
                    <p><span th:text="${addr.getDetailAddress()}">상세주소</span></p>
                    <hr>
                </div>
            </div>
            <div class="modalButton">
                <button type="button" id="addAddressBtn">배송지 추가</button>
            </div>
        </div>
    </div>
</div>

<script>
    setPrice();
</script>
</body>
</html>