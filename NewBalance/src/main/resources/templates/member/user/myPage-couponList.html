<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultrag.net.nz/thymeleaf/layout"
      layout:decorate="~{common/config/myPageLayout}"
      layout:fragment="myContent">
<head>
      <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
      <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

      <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

      <link rel="stylesheet" href="/css/member/member-couponList.css">


</head>

      <div class="my_cont">
            <div class="title_area">
                  <h3>쿠폰</h3>
            </div>
            <div class="sc_box">
                  <fieldset>
                        <legend>쿠폰 등록</legend>
                        <label for="couponName">쿠폰 등록</label>
                        <input type="text" id="couponName" name="couponName" class="ip_text" maxlength="50">
                        <button id="btnCouponReg" class="btn_ty_bface sm">등록하기</button>
                  </fieldset>
            </div>

            <ul class="star_noti">
                  <li>* 이벤트를 통해 발급 받은 쿠폰의 일련번호를 입력하십시오.</li>
                  <li>* 발급 받으신 쿠폰 일련번호를 등록기간 내에 등록하셔야 사용 가능합니다.</li>
            </ul>

            <div class="coupon_warp_re">
                  <h4 class="sec_tit">쿠폰 내역</h4>
                  <p class="sec_sub_txt">쿠폰별 사용조건이 상이하니 사용 전에 반드시 확인하시기 바랍니다.</p>
                  <div class="tab_list m60">
                        <ul class="col3">
                              <li>
                                    <a href="" th:onclick="searchCouponList('')">전체</a>
                              </li>
                              <li>
                                    <a href="" th:onclick="searchCouponList('1')">상품할인</a>
                              </li>
                              <li>
                                    <a href="" th:onclick="searchCouponList('2')">배송할인</a>
                              </li>
                        </ul>
                  </div>

                  <div>
                      <div class="sort_area">
                            <fieldset class="clearfix">

                                  <legend>MyNb 활동 내역 기간 선택</legend>
                                  <div class="period">
                                        <input type="radio" id="month1" name="period">
                                        <label for="month1">1개월</label>
                                        <input type="radio" id="month3" name="period">
                                        <label for="month3">3개월</label>
                                        <input type="radio" id="month6" name="period">
                                        <label for="month6">6개월</label>
                                        <input type="radio" id="year" name="period">
                                        <label for="year">1년</label>
                                  </div>

                                  <div class="right-wrap">
                                        <div class="date">
                                              <span class="datepicker">
                                                    <input type="text" title="시작일자" readonly="readonly" class="ip_text" id="sDate">
                                                    <a href="" class="btn_date" id="sDate2"></a>
                                              </span>
                                              <span class="unit">~</span>
                                              <span class="datepicker">
                                                    <input type="text" title="종료일자" readonly="readonly" class="ip_text" id="eDate">
                                                    <a href="" class="btn_date" id="eDate2"></a>
                                              </span>
                                              <a href="" class="btn_ty_gface xs" id="searchCoupon">조회</a>
                                        </div>
                                  </div>
                            </fieldset>
                      </div>

                        <div class="tbl_y">
                              <table class="coupon_list">
                                    <caption>쿠폰 내역</caption>
                                    <colgroup>
                                          <col style="width:123px">
                                          <col style="width:auto">
                                          <col style="width:auto">
                                    </colgroup>
                                    <thead id="couponTable">
                                          <tr>
                                                <th scope="col">혜택</th>
                                                <th scope="col">쿠폰명</th>
                                                <th scope="col">사용기간</th>
                                          </tr>
                                    </thead>
                                    <tbody id="couponTableBody">
                                    </tbody>
                              </table>
                        </div>
                        <div class="btn_area center" id="btnMore">
                              <a href="" class="btn_ty_more" id="viewMore" style="display: none">더보기</a>
                        </div>
                  </div>
            </div>
      </div>
<script>
      $(document).ready(function(){
            let offset = 0; // 초기 오프셋값
            const limit  = 3; // 한 번에 가져올 쿠폰 수

            $('#sDate').datepicker({
                  dateFormat: 'yy-mm-dd',
                  showMonthAfterYear: true,
                  changeYear: true,
                  changeMonth: true,
                  monthNamesShort: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
                  dayNamesMin: ['일', '월', '화', '수', '목', '금', '토'],
                  onSelect: function (dateText) {
                        $(this).val(dateText);
                        $('#eDate').datepicker('option', 'minDate', dateText);
                  },
            });
            $('#sDate2').click(function(event) {
                  event.preventDefault(); // 링크의 기본 동작을 방지
                  $('#sDate').datepicker('show'); // 날짜 선택기 표시
            });

            $('#eDate').datepicker({
                  dateFormat: 'yy-mm-dd',
                  showMonthAfterYear: true,
                  changeYear: true,
                  changeMonth: true,
                  monthNamesShort: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
                  dayNamesMin: ['일', '월', '화', '수', '목', '금', '토'],
                  onClose: function (dateText) {
                        $(this).val(dateText);
                  },
            });

            $('eDate2').click(function(event) {
                  event.preventDefault();
                  $('#eDate').datepicker('show');
            })

         // period 라는 이름을가진 라디오 버튼 선택
         $('input[name="period"]').change(function (){
            var today = new Date();
            var period = $(this).attr('id'); // 선택된 라디오 버튼의 id 가져오기
            var sDate;

            if(period === 'month1') {
                  sDate = formatDate(subtractPeriod(today, 1));
            } else if(period === 'month3') {
                  sDate = formatDate(subtractPeriod(today, 3));
            } else if(period === 'month6') {
                  sDate = formatDate(subtractPeriod(today, 6));
            } else if(period === 'year') {
                  sDate = formatDate(subtractPeriod(today, 12));
            }

            var eDate = formatDate(today);

            $('#sDate').val(sDate);
            $('#eDate').val(eDate);
         });

            // 현재날짜를 YYYY-MM-DD 형식으로 반환하는 함수
            function formatDate(date){
                  year = date.getFullYear();
                  month = ('0' + (date.getMonth() + 1)).slice(-2);
                  day = ('0' + date.getDate()).slice(-2);
                  return `${year}-${month}-${day}`
            }

            // 날짜를 특정 개월 수만큼 빼는 함수
            function subtractPeriod(date, months){
                  var newDate = new Date(date);
                  newDate.setMonth(newDate.getMonth() - months);
                  return newDate;
            }
            couponList();

            function couponList(){
                  const data = {
                        sDate: $('#sDate').val(),
                        period: $('#eDate').val(),
                        offset: offset,
                        limit: limit
                  }
                  $.ajax({
                     url: '/my/couponList',
                     data: data,
                     type: 'get',
                     success: function(response) {
                           const couponDtos = response.couponDtos;

                           const tableBody = $('#couponTableBody');

                           if( couponDtos.length > 0 ) {

                           // 서버에서 받은 데이터를 반복 처리하여 테이블 추가
                                 couponDtos.forEach(coupon => {
                                 const row = `<tr>
                                                <td>${coupon.benefit}%</td>
                                                <td>${coupon.title}</td>
                                                <td>
                                                      <span>${coupon.formattedSDate}</span>
                                                      <span> ~ </span>
                                                      <span>${coupon.formattedPeriod}</span>
                                                </td>
                                              </tr>`;
                                 tableBody.append(row);
                           });
                                 const reamingCount = Math.max(0, response.totalCount - (offset + limit));
                                 $('#viewMore').text('더보기(' + reamingCount + ')');

                                 if(reamingCount <= 0) {
                                       $('#viewMore').hide();
                                 } else {
                                       $('#viewMore').show();
                                 }
                     } else {
                                 tableBody.append('<tr><td colspan="3" class="no_data">' +
                                         '<p class="txt01">쿠폰 내역이 없습니다.</p>' +
                                         '</td></tr>');
                           }
                        },
                        error: function(xhr, status, error){
                           console.error('실패');
                        }
                  });
            }

            $('#viewMore').click(function (event){
                  event.preventDefault();
                  offset += limit; // 오프셋 증가
                  couponList();
            })


            // 쿠폰 등록
            $('#btnCouponReg').click(function(event){
                  event.preventDefault();
                  const couponName = $('#couponName').val();
                  $.ajax({
                        url: '/my/couponAdd',
                        type: 'POST',
                        data: {code: couponName},
                        dataType: 'json',
                        success: function(response) {
                              alert(response);
                              $('#couponName').val('');
                              couponList();
                        },
                        error:function(xhr, status, error){
                              alert(xhr.responseText); // 에러 메시지 표시
                        }
                  });
            });

            $('#searchCoupon').click(function (event){
                  event.preventDefault();
                  couponList();
            });
      });
</script>
</html>